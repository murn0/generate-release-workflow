name: Generate release
on:
  workflow_call:
    inputs:
      changelog_config_json:
        required: false
        type: string
      major_title:
        description: "Titles that fall under major version upgrades. e.g. ## ⚠️ Breaking Changes"
        required: true
        type: string
      minor_title:
        description: "Titles that fall under minor version upgrades. e.g. ## 🚀 Features"
        required: true
        type: string

permissions: {}
jobs:
  build-changelog:
    uses: ./.github/workflows/build-changelog.yaml
    permissions: {}
    with:
      changelog_config_json: ${{inputs.changelog_config_json}}
  bump-version:
    uses: ./.github/workflows/bump-version.yaml
    permissions: {}
    if: success()
    needs:
      - build-changelog
    with:
      changelog: ${{needs.build-changelog.outputs.changelog}}
      major_title: ${{inputs.major_title}}
      minor_title: ${{inputs.minor_title}}
  check-milestone:
    uses: ./.github/workflows/check-milestone.yaml
    permissions:
      issues: write # For create milestone
    needs:
      - bump-version
    with:
      RELEASE_VERSION: ${{needs.bump-version.outputs.RELEASE_VERSION}}
  generate-release-pull-request:
    uses: ./.github/workflows/generate-release-pull-request.yaml
    permissions: {}
    needs: 
      - build-changelog
      - bump-version
      - check-milestone
    secrets:
      gh_app_id: ${{secrets.GH_APP_ID}}
      gh_app_private_key: ${{secrets.GH_APP_PRIVATE_KEY}}
    with:
      CHANGELOG_HEADER: >-
        [Pull Requests](https://github.com/${{github.repository}}/pulls?q=is%3Apr+milestone%3A${{needs.bump-version.outputs.RELEASE_VERSION}}) |
        [Issues](https://github.com/${{github.repository}}/issues?q=is%3Aissue+milestone%3A${{needs.bump-version.outputs.RELEASE_VERSION}}) |
        [Milestone](https://github.com/${{github.repository}}/milestone/${{needs.check-milestone.outputs.MILESTONE_NUMBER}}) |
        https://github.com/${{github.repository}}/compare/${{needs.build-changelog.outputs.LATEST_TAG}}...${{needs.bump-version.outputs.RELEASE_VERSION}}
      CHANGELOG: ${{needs.build-changelog.outputs.changelog}}
      RELEASE_VERSION: ${{needs.bump-version.outputs.RELEASE_VERSION}}